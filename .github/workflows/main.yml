name: Build Kernel (Odin 5.4 + KernelSU)

on:
  workflow_dispatch:
    inputs:
      defconfig:
        description: "Defconfig under arch/arm64/configs (e.g. odin_defconfig)"
        required: true
        default: "odin_defconfig"
      lto:
        description: "Enable LTO? (true/false)"
        required: true
        default: "true"

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      # Build identity
      KBUILD_BUILD_USER: builder
      KBUILD_BUILD_HOST: builder-vendor-48059-417397120388620288
      KBUILD_BUILD_TIMESTAMP: "Fri Jul 26 11:35:31 UTC 2023"

      # Repo tool paths
      CLANG_DIR: scripts/tools/clang-r383902b1
      ANYKERNEL_DIR: scripts/tools/AnyKernel3

      # Kernel build
      OUT_DIR: out
      ARCH: arm64
      SUBARCH: arm64

      # Toolchain settings (match your args)
      CC: clang
      LD: ld.lld
      AR: llvm-ar
      NM: llvm-nm
      STRIP: llvm-strip
      OBJCOPY: llvm-objcopy
      OBJDUMP: llvm-objdump
      READELF: llvm-readelf
      HOSTCC: clang
      HOSTCXX: clang++
      HOSTAR: llvm-ar
      HOSTLD: ld.lld
      CLANG_TRIPLE: aarch64-linux-gnu-
      CROSS_COMPILE: aarch64-linux-gnu-
      CROSS_COMPILE_COMPAT: arm-linux-gnueabi-
      LLVM: "1"
      LLVM_IAS: "1"

      # ccache
      CCACHE_COMPRESS: "true"
      CCACHE_COMPRESSLEVEL: "6"
      CCACHE_MAXSIZE: "3G"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: recursive

      - name: Install dependencies (minimal + reliable)
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            git ccache bc bison flex make \
            build-essential \
            libssl-dev libelf-dev \
            libncurses-dev \
            liblz4-tool lzop \
            zip unzip curl \
            python-is-python3 \
            gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ${{ runner.os }}-ccache-${{ github.ref_name }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-ccache-${{ github.ref_name }}-
            ${{ runner.os }}-ccache-

      - name: Export PATH (clang + ccache) and sanity check
        run: |
          echo "${GITHUB_WORKSPACE}/${CLANG_DIR}/bin" >> $GITHUB_PATH
          echo "/usr/lib/ccache" >> $GITHUB_PATH

          clang --version
          ld.lld --version
          llvm-ar --version || true
          aarch64-linux-gnu-gcc --version
          arm-linux-gnueabi-gcc --version
          ccache --version

      - name: Configure kernel (defconfig)
        run: |
          mkdir -p "${OUT_DIR}"
          make -j"$(nproc)" O="${OUT_DIR}" ARCH="${ARCH}" SUBARCH="${SUBARCH}" "${{ inputs.defconfig }}"

      - name: Optional: disable LTO
        if: ${{ inputs.lto == 'false' }}
        run: |
          # Some trees include scripts/config; if not present, just skip safely.
          if [ -f "${GITHUB_WORKSPACE}/scripts/config" ]; then
            chmod +x "${GITHUB_WORKSPACE}/scripts/config" || true
            "${GITHUB_WORKSPACE}/scripts/config" --file "${OUT_DIR}/.config" \
              -d LTO_CLANG -d LTO -d THINLTO || true
            make -j"$(nproc)" O="${OUT_DIR}" ARCH="${ARCH}" SUBARCH="${SUBARCH}" olddefconfig
          else
            echo "scripts/config not found, skipping LTO toggle."
          fi

      - name: Build kernel
        run: |
          export PATH="${GITHUB_WORKSPACE}/${CLANG_DIR}/bin:$PATH"

          make -j"$(nproc)" \
            O="${OUT_DIR}" ARCH="${ARCH}" SUBARCH="${SUBARCH}" \
            CC="${CC}" LD="${LD}" AR="${AR}" NM="${NM}" STRIP="${STRIP}" \
            OBJCOPY="${OBJCOPY}" OBJDUMP="${OBJDUMP}" READELF="${READELF}" \
            HOSTCC="${HOSTCC}" HOSTCXX="${HOSTCXX}" HOSTAR="${HOSTAR}" HOSTLD="${HOSTLD}" \
            CLANG_TRIPLE="${CLANG_TRIPLE}" CROSS_COMPILE="${CROSS_COMPILE}" CROSS_COMPILE_COMPAT="${CROSS_COMPILE_COMPAT}" \
            LLVM="${LLVM}" LLVM_IAS="${LLVM_IAS}" \
            CCACHE=ccache

      - name: Locate kernel image
        run: |
          echo "Boot output dir:"
          ls -lah "${OUT_DIR}/arch/arm64/boot" || true

          IMG=""
          for f in \
            "${OUT_DIR}/arch/arm64/boot/Image.gz-dtb" \
            "${OUT_DIR}/arch/arm64/boot/Image.gz" \
            "${OUT_DIR}/arch/arm64/boot/Image"; do
            if [ -f "$f" ]; then IMG="$f"; break; fi
          done

          if [ -z "$IMG" ]; then
            echo "ERROR: Kernel image not found in out/arch/arm64/boot"
            exit 1
          fi

          echo "KERNEL_IMAGE=$IMG" >> $GITHUB_ENV
          echo "Found kernel image: $IMG"

      - name: Package AnyKernel3 zip
        run: |
          AK="${GITHUB_WORKSPACE}/${ANYKERNEL_DIR}"
          if [ ! -d "$AK" ]; then
            echo "ERROR: AnyKernel3 dir not found: $AK"
            exit 1
          fi

          # Clean old outputs
          rm -f "$AK"/*.zip || true
          rm -f "$AK"/Image* || true

          # Copy image into AnyKernel3
          cp -v "${KERNEL_IMAGE}" "$AK/"

          # If your anykernel.sh expects a fixed filename, normalize here.
          # Example (uncomment if needed):
          # (cd "$AK" && for f in Image*; do [ "$f" = "Image.gz-dtb" ] || mv -f "$f" "Image.gz-dtb"; done)

          ZIP_NAME="KernelSU-${GITHUB_REF_NAME}-${GITHUB_RUN_NUMBER}.zip"
          (cd "$AK" && zip -r9 "../$ZIP_NAME" ./*)

          echo "ZIP_PATH=${GITHUB_WORKSPACE}/scripts/tools/$ZIP_NAME" >> $GITHUB_ENV
          ls -lah "${GITHUB_WORKSPACE}/scripts/tools/$ZIP_NAME"

      - name: Upload AnyKernel3 zip
        uses: actions/upload-artifact@v4
        with:
          name: AnyKernel3-zip
          path: ${{ env.ZIP_PATH }}

      - name: Upload raw outputs (optional)
        uses: actions/upload-artifact@v4
        with:
          name: kernel-raw-out
          path: |
            out/arch/arm64/boot/Image*
            out/.config
