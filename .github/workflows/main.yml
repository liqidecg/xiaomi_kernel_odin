name: Build Kernel (Odin 5.4)

on:
  workflow_dispatch:
    inputs:
      defconfig:
        description: "Defconfig under arch/arm64/configs (e.g. odin_defconfig)"
        required: true
        default: "odin_defconfig"

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      KBUILD_BUILD_USER: builder
      KBUILD_BUILD_HOST: builder-vendor-48059-417397120388620288
      KBUILD_BUILD_TIMESTAMP: "Fri Jul 26 11:35:31 UTC 2023"

      CLANG_DIR: scripts/tools/clang-r383902b1
      ANYKERNEL_DIR: scripts/tools/AnyKernel3

      OUT_DIR: out
      ARCH: arm64
      SUBARCH: arm64

      CC: clang
      LD: ld.lld
      AR: llvm-ar
      NM: llvm-nm
      STRIP: llvm-strip
      OBJCOPY: llvm-objcopy
      OBJDUMP: llvm-objdump
      READELF: llvm-readelf
      HOSTCC: clang
      HOSTCXX: clang++
      HOSTAR: llvm-ar
      HOSTLD: ld.lld

      CLANG_TRIPLE: aarch64-linux-gnu-
      CROSS_COMPILE: aarch64-linux-gnu-
      CROSS_COMPILE_COMPAT: arm-linux-gnueabi-
      LLVM: "1"
      LLVM_IAS: "1"

      CCACHE_COMPRESS: "true"
      CCACHE_COMPRESSLEVEL: "6"
      CCACHE_MAXSIZE: "3G"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git ccache automake flex lzop bison gperf build-essential zip curl \
            zlib1g-dev g++-multilib libxml2-utils bzip2 libbz2-dev squashfs-tools \
            pngcrush schedtool dpkg-dev liblz4-tool make optipng maven libssl-dev \
            pwgen libswitch-perl policycoreutils minicom libxml-sax-base-perl \
            libxml-simple-perl bc libc6-dev-i386 lib32ncurses-dev x11proto-core-dev \
            libx11-dev lib32z1-dev libgl1-mesa-dev xsltproc unzip openjdk-17-jdk \
            python-is-python3 \
            gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ${{ runner.os }}-ccache-${{ github.ref_name }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-ccache-${{ github.ref_name }}-
            ${{ runner.os }}-ccache-

      - name: Toolchain sanity check
        run: |
          echo "${GITHUB_WORKSPACE}/${CLANG_DIR}/bin" >> $GITHUB_PATH
          echo "/usr/lib/ccache" >> $GITHUB_PATH
          clang --version
          ld.lld --version
          aarch64-linux-gnu-gcc --version
          arm-linux-gnueabi-gcc --version
          ccache --version

      - name: Configure (defconfig)
        run: |
          mkdir -p "${OUT_DIR}"
          make -j"$(nproc)" O="${OUT_DIR}" ARCH="${ARCH}" SUBARCH="${SUBARCH}" "${{ inputs.defconfig }}"

      - name: Build
        run: |
          export PATH="${GITHUB_WORKSPACE}/${CLANG_DIR}/bin:$PATH"
          make -j"$(nproc)" \
            O="${OUT_DIR}" ARCH="${ARCH}" SUBARCH="${SUBARCH}" \
            CC="${CC}" LD="${LD}" AR="${AR}" NM="${NM}" STRIP="${STRIP}" \
            OBJCOPY="${OBJCOPY}" OBJDUMP="${OBJDUMP}" READELF="${READELF}" \
            HOSTCC="${HOSTCC}" HOSTCXX="${HOSTCXX}" HOSTAR="${HOSTAR}" HOSTLD="${HOSTLD}" \
            CLANG_TRIPLE="${CLANG_TRIPLE}" CROSS_COMPILE="${CROSS_COMPILE}" CROSS_COMPILE_COMPAT="${CROSS_COMPILE_COMPAT}" \
            LLVM="${LLVM}" LLVM_IAS="${LLVM_IAS}" \
            CCACHE=ccache

      - name: Find kernel image
        run: |
          IMG=""
          for f in \
            "${OUT_DIR}/arch/arm64/boot/Image.gz-dtb" \
            "${OUT_DIR}/arch/arm64/boot/Image.gz" \
            "${OUT_DIR}/arch/arm64/boot/Image"; do
            if [ -f "$f" ]; then IMG="$f"; break; fi
          done
          if [ -z "$IMG" ]; then
            echo "ERROR: Kernel image not found"
            ls -lah "${OUT_DIR}/arch/arm64/boot" || true
            exit 1
          fi
          echo "KERNEL_IMAGE=$IMG" >> $GITHUB_ENV
          echo "Found: $IMG"

      - name: Package AnyKernel3 zip
        run: |
          AK="${GITHUB_WORKSPACE}/${ANYKERNEL_DIR}"
          test -d "$AK"

          rm -f "$AK"/*.zip || true
          rm -f "$AK"/Image* || true
          cp -v "${KERNEL_IMAGE}" "$AK/"

          ZIP_NAME="KernelSU-${GITHUB_REF_NAME}-${GITHUB_RUN_NUMBER}.zip"
          (cd "$AK" && zip -r9 "../$ZIP_NAME" ./*)

          echo "ZIP_PATH=${GITHUB_WORKSPACE}/scripts/tools/$ZIP_NAME" >> $GITHUB_ENV
          ls -lah "${GITHUB_WORKSPACE}/scripts/tools/$ZIP_NAME"

      - name: Upload AnyKernel3 zip
        uses: actions/upload-artifact@v4
        with:
          name: AnyKernel3-zip
          path: ${{ env.ZIP_PATH }}
